<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" id="viewport" name="viewport">
	<title>校园卡查询～</title>
	<link rel="stylesheet" href="./css/search.css" />
	<link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.css" rel="stylesheet" />
</head>
<body>
<div id="search">
<div class="bg"></div>
<div id="contain">
<div class="top">
	<div class="nav abled">快捷查询</div>
	<div class="nav">一键挂失</div>
	<div class="nav">一键解挂</div>
</div>
<div class="cln">
	<input type="number" name="account" placeholder="请输入学号" />
</div>

<div class="cln">
	<input type="password" name="passwd" placeholder="请输入密码(默认密码为身份证后6位)">
</div>

<button id="send" data="1">
	<span class="searching" style="display: none">
		<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i>正在查询中，请稍后...
	</span>
	<span class="nosearch">查询</span>
	<span class="losing" style="display: none">
		<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i>正在挂失中，请稍后...
	</span>
	<span class="nolosing" style="display: none">
		<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i>正在解挂中，请稍后...
	</span>
</button>
</div>
<div class="note">
	数据来源：鲁东大学校园卡系统。
</div>
<div class="note">
	技术支持：<a href="http://www.ldustu.com" target="_blank">鲁东大学学生网</a>
</div>
</div>
<div id="result" style="display:none">
	<div class="r-top" style="background-color:#000;text-align:center;">
		<a href="javascript:window.location.reload();" class="back">&#60;&nbsp;返回</a>
		<span style="color:#fff;font-weight:800;font-size:18px">查询结果</span>
	</div>
	<div class="r-top" style="text-align: center">
		&nbsp;&nbsp;卡号:
		<span style="font-size:16px;font-weight:800;" class="card-num"></span>
		&nbsp;&nbsp;&nbsp;余额:
		<span style="font-size:16px;font-weight:800;" class="card-money"></span>
		元<!--span class="what">?</span-->&nbsp;&nbsp;&nbsp;状态:
		<span class="card-status" style="font-size:16px;"></span>
	</div>
	<div id="alert" style="display:none;text-align: center;margin-top:100px;"></div>
</div>
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
<script>
$(".nav:eq(0)").click(function() {
	if ($(".nav:eq(0)").hasClass('abled')) {
		return
	} else {
		$('#send').attr('data', '1');
		$('#send').css('background-color', '#0089EE');
		$('#send').css('box-shadow', '0px 5px 30px #0089EE');
		$('.nosearch').text('查询');
		$(".nav:eq(0)").addClass('abled');
		$(".nav:eq(1)").removeClass('abled');
		$(".nav:eq(2)").removeClass('abled')
	}
});
$(".nav:eq(1)").click(function() {
	if ($(".nav:eq(1)").hasClass('abled')) {
		return
	} else {
		$('#send').attr('data', '2');
		$('#send').css('background-color', '#f56767');
		$('#send').css('box-shadow', '0px 5px 30px #f56767');
		$('.nosearch').text('挂失');
		$(".nav:eq(1)").addClass('abled');
		$(".nav:eq(0)").removeClass('abled');
		$(".nav:eq(2)").removeClass('abled')
	}
});
$(".nav:eq(2)").click(function() {
	if ($(".nav:eq(2)").hasClass('abled')) {
		return
	} else {
		$('#send').attr('data', '3');
		$('#send').css('background-color', '#61c961');
		$('#send').css('box-shadow', '0px 5px 30px #61c961');
		$('.nosearch').text('解挂');
		$(".nav:eq(2)").addClass('abled');
		$(".nav:eq(0)").removeClass('abled');
		$(".nav:eq(1)").removeClass('abled')
	}
});
$('#send').on('click', function() {
	var account = $('input[name=account]').val();
	var passwd = $('input[name=passwd]').val();
	if (account.length != 11) {
		alert("学号格式不正确");
		return
	}
	if (!passwd.length) {
		alert("请输入密码");
		return
	}
	if ($('#send').attr('data') == 1) {
		$('.nosearch').hide();
		$('.searching').show();
		$('#send').attr('disabled', 'disabled');
		$.ajax({
			url: './test.php',
			async: true,
			data: {
				account: account,
				passwd: passwd
			},
			dataType: "html",
			type: 'POST',
			success: function(result) {
				if (result == "error") {
					$('.nosearch').show();
					$('.searching').hide();
					$('#send').attr('disabled', false);
					alert("密码错误，请重试");
					return
				}
				$('#search').slideUp();
				var data = $(result).find("table");
				var new_result = result.substring(result.length - 40, result.length);
				var reg_num = /<em>([1-9]\d*|0)<\/em>/g;
				var reg_money = /<i>([1-9]\d*\.\d*|0\.\d*[1-9]\d*)<\/i>/g;
				var reg_status = /<b>(.*)<\/b>/g;
				var card_num = $(new_result.match(reg_num)[0]).text();
				var card_money = $(new_result.match(reg_money)[0]).text();
				var card_status = $(new_result.match(reg_status)[0]).text();
				$('.card-num').text(card_num);
				$('.card-money').text(card_money);
				if (card_status == "正常") {
					$('.card-status').text("正常");
					$('.card-status').css('color', '#61c961')
				} else {
					$('.card-status').text("已挂失");
					$('.card-status').css('color', 'red')
				}
				$('body').css('background-color', '#fff');
				var alldata = data.children().children().children();
				var times = (alldata.length - 14) / 10;
				if (times < 1) {
					$('#alert').text("未查询到饮水以外的消费记录");
					$('#alert').show()
				}
				for (var i = 0; i < times; i++) {
					var arrtimes = i * 10 + 13;
					var domtimes = alldata[arrtimes];
					var place = $(alldata[arrtimes + 4]).text();
					if (place.indexOf('饮水') != -1) {
						continue
					}
					var money2 = "";
					if (money($(alldata[arrtimes + 5]).text())) {
						money2 = money($(alldata[arrtimes + 5]).text())
					} else {
						place = "银行卡转帐";
						money2 = "+" + $(alldata[arrtimes + 5]).text()
					}
					var html = "<div class=\"list\"><div class=\"mtime\"><span class=\"mt-top\">今天</span><span class=\"mt-bot\">" + $(alldata[arrtimes]).text().substr(11, 5) + "</span></div><div class=\"yes\"><i class=\"fa fa-check-circle\"></i></div><div class=\"mdetail\"><span class=\"md-top\">" + money2 + "</span><span class=\"md-bot\">" + place + "</span></div></div>";
					$('#result').append(html)
				}
				$('#result').show()
			},
			error: function() {
				alert('无法连接服务器，请联系我们修复！');
				$('.nosearch').show();
				$('.searching').hide();
				$('#send').attr('disabled', false)
			},
		})
	} else if ($('#send').attr('data') == 2) {
		var r = confirm("你确定要挂失吗？");
		if (r == true) {
			$('.nosearch').hide();
			$('.losing').show();
			$('#send').attr('disabled', 'disabled');
			$.ajax({
				url: './loss.php',
				async: true,
				data: {
					account: account,
					passwd: passwd
				},
				dataType: "html",
				type: 'POST',
				success: function(result) {
					if (result == "error") {
						$('.nosearch').show();
						$('.searching').hide();
						$('#send').attr('disabled', false);
						alert("密码错误，请重试");
						return
					}
					if ($(result).find('.biaotou').text() == "持卡人已挂失") {
						alert('您已经是挂失状态！')
					} else if ($(result).find('.biaotou').text() == "操作成功。如在7天内没找到失卡，请到校园卡服务部重新办理校园卡！") {
						alert('挂失成功！')
					} else {
						alert('系统异常，请联系我们修复！')
					}
					$('.nosearch').show();
					$('.losing').hide();
					$('#send').attr('disabled', false)
				},
				error: function() {
					alert('无法连接服务器，请联系我们修复！');
					$('.nosearch').show();
					$('.losing').hide();
					$('#send').attr('disabled', false)
				},
			})
		}
	} else {
		var r2 = confirm("你确定要解挂吗？");
		if (r2 == true) {
			$('.nosearch').hide();
			$('.nolosing').show();
			$('#send').attr('disabled', 'disabled');
			$.ajax({
				url: './noloss.php',
				async: true,
				data: {
					account: account,
					passwd: passwd
				},
				dataType: "html",
				type: 'POST',
				success: function(result) {
					if (result == "error") {
						$('.nosearch').show();
						$('.searching').hide();
						$('#send').attr('disabled', false);
						alert("密码错误，请重试");
						return
					}
					if ($(result).find('.biaotou').text() == "持卡人已解挂") {
						alert('你的校园卡不在挂失状态，解挂失败')
					} else if ($(result).find('.biaotou').text() == "操作成功") {
						alert('解挂成功')
					} else {
						alert('系统异常，请联系我们修复！')
					}
					$('.nosearch').show();
					$('.nolosing').hide();
					$('#send').attr('disabled', false)
				},
				error: function() {
					alert('无法连接服务器，请联系我们修复！');
					$('.nosearch').show();
					$('.nolosing').hide();
					$('#send').attr('disabled', false)
				},
			})
		}
	}
});

function money(m) {
	var addor = m.substr(0, 1);
	if (addor == "-") return m.substr(1);
	else return 0
}
</script>
</body>

</html>
